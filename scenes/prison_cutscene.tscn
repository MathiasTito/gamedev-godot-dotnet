[gd_scene load_steps=22 format=3 uid="uid://ce8s40xfu5eh7"]

[ext_resource type="Texture2D" uid="uid://b57rd0chgvlh" path="res://assets/background/prison.png" id="1_1661b"]
[ext_resource type="Script" uid="uid://ugxla8qc0pk0" path="res://scenes/prison_cutscene.gd" id="1_xr6cb"]
[ext_resource type="Texture2D" uid="uid://cniw5w3isprlc" path="res://assets/policial/GuardaParado.png" id="3_b1ot8"]
[ext_resource type="Script" uid="uid://c6ifjtqrn570j" path="res://scenes/character_portraits.gd" id="3_ft4dl"]
[ext_resource type="Texture2D" uid="uid://buag02hdmu6hd" path="res://assets/main_char/ParadoCadeia.png" id="4_ft4dl"]
[ext_resource type="Texture2D" uid="uid://by45asyecwkhj" path="res://assets/UI/V (1).png" id="5_ft4dl"]

[sub_resource type="GDScript" id="GDScript_b1ot8"]
script/source = "extends Control

@onready var dialogue_box = $DialogueBox
@onready var character_name = $DialogueBox/NameLabel
@onready var dialogue_text = $DialogueBox/TextLabel
@onready var continue_button = $DialogueBox/ContinueButton
@onready var gray_filter = $GrayFilter
@onready var left_portrait = $CharacterPortraits/LeftPortraits
@onready var right_portrait = $CharacterPortraits/RightPortraits

var dialogue_data: Array = []
var current_dialogue_index: int = 0
var is_dialogue_active: bool = false
var text_speed: float = 0.03
var is_typing: bool = false

var dialogue_step: int = 0  # controla se estamos no 1º ou 2º diálogo

signal dialogue_finished


func _ready():
	dialogue_box.visible = false
	gray_filter.visible = true
	continue_button.pressed.connect(_on_continue_pressed)

	if left_portrait.has_method(\"play\"):
		left_portrait.play()

	if right_portrait.has_method(\"play\"):
		right_portrait.play()

	# Quando qualquer diálogo termina, avança para o próximo passo
	dialogue_finished.connect(_on_dialogue_finished)

	await get_tree().create_timer(0.5).timeout
	start_first_dialogue()


# ============================================================
# PRIMEIRO DIÁLOGO
# ============================================================

func start_first_dialogue():
	dialogue_step = 1

	var auto_dialogue = [
		{\"character\": \"Guarda\", \"text\": \"Você finalmente vai sair depois de 5 anos.\"},
		{\"character\": \"Guarda\", \"text\": \"Mas não vai durar por muito tempo, a gente sabe o que você fez.\"},
		{\"character\": \"Guarda\", \"text\": \"E gente que nem você nunca terá nada.\"},
		{\"character\": \"V\", \"text\": \"Eu não me importo com essa sua falação.\"},
		{\"character\": \"V\", \"text\": \"Se eu tivesse outra oportunidade, faria tudo igual.\"},
		{\"character\": \"Guarda\", \"text\": \"Vamos ver quanto tempo dura essa sua marra.\"}
	]

	start_dialogue(auto_dialogue)


# ============================================================
# SEGUNDO DIÁLOGO
# ============================================================

func start_second_dialogue():
	dialogue_step = 2

	right_portrait.visible = false

	var pensamento = [
		{\"character\": \"V\", \"text\": \"Vou naquela delegacia caçar informações.\"},
		{\"character\": \"V\", \"text\": \"Vou me vingar dele.\"}
	]

	start_dialogue(pensamento)


# ============================================================
# AÇÃO APÓS DIÁLOGO — MUDA CENA
# ============================================================

func _on_dialogue_finished():

	if dialogue_step == 1:
		# terminou o primeiro diálogo → inicia o segundo
		start_second_dialogue()
		return

	if dialogue_step == 2:
		# terminou o segundo diálogo → troca de cena
		_load_next_scene()
		return


func _load_next_scene():
	# COLOQUE AQUI O CAMINHO DA CENA DE DESTINO
	var next_scene_path = \"res://scenes/main.tscn\"
	
	get_tree().change_scene_to_file(next_scene_path)


# ============================================================
# SISTEMA DE DIÁLOGO (GENERALIZADO)
# ============================================================

func start_dialogue(dialogue_array: Array) -> void:
	dialogue_data = dialogue_array
	current_dialogue_index = 0
	is_dialogue_active = true

	gray_filter.visible = true
	dialogue_box.visible = true

	show_current_dialogue()


func show_current_dialogue():
	if current_dialogue_index >= dialogue_data.size():
		end_dialogue()
		return

	var current_data = dialogue_data[current_dialogue_index]
	character_name.text = current_data.get(\"character\", \"\")
	start_typing_animation(current_data.get(\"text\", \"\"))


func start_typing_animation(text: String) -> void:
	is_typing = true
	dialogue_text.text = \"\"
	continue_button.visible = false

	for i in text.length():
		dialogue_text.text += text[i]
		await get_tree().create_timer(text_speed).timeout

		if Input.is_action_just_pressed(\"ui_accept\"):
			dialogue_text.text = text
			break

	is_typing = false
	continue_button.visible = true


func _on_continue_pressed():
	if is_typing:
		return

	current_dialogue_index += 1
	show_current_dialogue()


func end_dialogue():
	is_dialogue_active = false
	dialogue_box.visible = false
	gray_filter.visible = false

	dialogue_finished.emit()


func _unhandled_input(event):
	if not is_dialogue_active or is_typing:
		return

	if event.is_action_pressed(\"ui_accept\") or event.is_action_pressed(\"ui_select\"):
		_on_continue_pressed()
"

[sub_resource type="GDScript" id="GDScript_1661b"]
script/source = "extends ColorRect

func _ready():
	visible = true
	set_anchors_and_offsets_preset(Control.PRESET_FULL_RECT)

	color = Color(0.2, 0.2, 0.2, 0.8)

func activate_filter():
	visible = true

func deactivate_filter():
	visible = false
"

[sub_resource type="AtlasTexture" id="AtlasTexture_xr6cb"]
atlas = ExtResource("3_b1ot8")
region = Rect2(0, 0, 80, 256)

[sub_resource type="AtlasTexture" id="AtlasTexture_03d2k"]
atlas = ExtResource("3_b1ot8")
region = Rect2(80, 0, 80, 256)

[sub_resource type="AtlasTexture" id="AtlasTexture_p1je7"]
atlas = ExtResource("3_b1ot8")
region = Rect2(160, 0, 80, 256)

[sub_resource type="AtlasTexture" id="AtlasTexture_qh0bm"]
atlas = ExtResource("3_b1ot8")
region = Rect2(240, 0, 80, 256)

[sub_resource type="SpriteFrames" id="SpriteFrames_ntjli"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_xr6cb")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_03d2k")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_p1je7")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_qh0bm")
}],
"loop": true,
"name": &"default",
"speed": 5.0
}]

[sub_resource type="AtlasTexture" id="AtlasTexture_b1ot8"]
atlas = ExtResource("4_ft4dl")
region = Rect2(0, 0, 76, 228)

[sub_resource type="AtlasTexture" id="AtlasTexture_ft4dl"]
atlas = ExtResource("4_ft4dl")
region = Rect2(76, 0, 76, 228)

[sub_resource type="AtlasTexture" id="AtlasTexture_ntjli"]
atlas = ExtResource("4_ft4dl")
region = Rect2(152, 0, 76, 228)

[sub_resource type="AtlasTexture" id="AtlasTexture_81pkf"]
atlas = ExtResource("4_ft4dl")
region = Rect2(228, 0, 76, 228)

[sub_resource type="SpriteFrames" id="SpriteFrames_xr6cb"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_b1ot8")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ft4dl")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ntjli")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_81pkf")
}],
"loop": true,
"name": &"default",
"speed": 5.0
}]

[sub_resource type="Animation" id="Animation_03d2k"]
length = 0.001
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("FadeOverlay:modulate")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Color(1, 1, 1, 1)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("TextureRect:modulate")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Color(1, 1, 1, 1)]
}

[sub_resource type="Animation" id="Animation_xr6cb"]
resource_name = "fade_in"
length = 1.5
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("FadeOverlay:modulate")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0.03333334, 1.5),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Color(1, 1, 1, 1), Color(1, 1, 1, 0)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("TextureRect:modulate")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0.033333335, 1.5),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Color(1, 1, 1, 1), Color(1, 1, 1, 0)]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_p1je7"]
_data = {
&"RESET": SubResource("Animation_03d2k"),
&"fade_in": SubResource("Animation_xr6cb")
}

[node name="PrisonCutscene" type="Node2D"]
script = ExtResource("1_xr6cb")

[node name="DialogueManager" type="Control" parent="."]
layout_mode = 3
anchors_preset = 0
offset_right = 1920.0
offset_bottom = 1080.0
script = SubResource("GDScript_b1ot8")

[node name="TextureRect" type="TextureRect" parent="DialogueManager"]
layout_mode = 0
offset_right = 1920.0
offset_bottom = 1080.0
texture = ExtResource("1_1661b")

[node name="GrayFilter" type="ColorRect" parent="DialogueManager"]
visible = false
layout_mode = 0
offset_right = 1920.0
offset_bottom = 1080.0
script = SubResource("GDScript_1661b")

[node name="DialogueBox" type="Panel" parent="DialogueManager"]
layout_mode = 0
offset_left = 569.0
offset_top = 908.0
offset_right = 1379.0
offset_bottom = 1019.0

[node name="NameLabel" type="Label" parent="DialogueManager/DialogueBox"]
layout_mode = 0
offset_left = 12.0
offset_top = 8.0
offset_right = 134.0
offset_bottom = 43.0

[node name="TextLabel" type="Label" parent="DialogueManager/DialogueBox"]
layout_mode = 0
offset_left = 17.0
offset_top = 47.0
offset_right = 776.0
offset_bottom = 88.0

[node name="ContinueButton" type="Button" parent="DialogueManager/DialogueBox"]
layout_mode = 0
offset_left = 679.0
offset_top = 79.0
offset_right = 810.0
offset_bottom = 111.0

[node name="CharacterPortraits" type="HBoxContainer" parent="DialogueManager"]
layout_mode = 0
offset_top = 264.0
offset_right = 1920.0
offset_bottom = 1080.0
script = ExtResource("3_ft4dl")

[node name="RightPortraits" type="AnimatedSprite2D" parent="DialogueManager/CharacterPortraits"]
position = Vector2(1582, 692)
scale = Vector2(4.25781, 4.25781)
sprite_frames = SubResource("SpriteFrames_ntjli")
flip_h = true

[node name="LeftPortraits" type="AnimatedSprite2D" parent="DialogueManager/CharacterPortraits"]
position = Vector2(334, 710)
scale = Vector2(4.25781, 4.25781)
sprite_frames = SubResource("SpriteFrames_xr6cb")

[node name="FadeOverlay" type="ColorRect" parent="."]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = -244.0
offset_top = -132.0
offset_right = 2192.5154
offset_bottom = 1243.0
grow_horizontal = 2
grow_vertical = 2
mouse_filter = 2
color = Color(0, 0, 0, 1)

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
libraries = {
&"": SubResource("AnimationLibrary_p1je7")
}

[node name="TextureRect" type="TextureRect" parent="."]
offset_left = 616.0
offset_top = 206.0
offset_right = 1304.2582
offset_bottom = 727.0
texture = ExtResource("5_ft4dl")
expand_mode = 1
