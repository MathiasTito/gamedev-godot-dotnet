[gd_scene load_steps=17 format=3 uid="uid://ce8s40xfu5eh7"]

[ext_resource type="Texture2D" uid="uid://b57rd0chgvlh" path="res://assets/background/prison.png" id="1_1661b"]
[ext_resource type="Texture2D" uid="uid://cniw5w3isprlc" path="res://assets/policial/GuardaParado.png" id="3_b1ot8"]
[ext_resource type="Script" uid="uid://c6ifjtqrn570j" path="res://scenes/character_portraits.gd" id="3_ft4dl"]
[ext_resource type="Texture2D" uid="uid://buag02hdmu6hd" path="res://assets/main_char/ParadoCadeia.png" id="4_ft4dl"]

[sub_resource type="GDScript" id="GDScript_b1ot8"]
script/source = "extends Control

@onready var dialogue_box = $DialogueBox
@onready var character_name = $DialogueBox/NameLabel
@onready var dialogue_text = $DialogueBox/TextLabel
@onready var continue_button = $DialogueBox/ContinueButton
@onready var gray_filter = $GrayFilter
@onready var left_portrait = $CharacterPortraits/LeftPortraits
@onready var right_portrait = $CharacterPortraits/RightPortraits

var dialogue_data = []
var current_dialogue_index = 0
var is_dialogue_active = false
var text_speed = 0.03
var is_typing = false

signal dialogue_finished

func _ready():
	dialogue_box.visible = false
	gray_filter.visible = true
	left_portrait.play()
	right_portrait.play()
	continue_button.pressed.connect(_on_continue_pressed)
	
	await get_tree().create_timer(0.5).timeout
	start_auto_dialogue()
	
func start_auto_dialogue():
	\"\"\"Inicia um diálogo automático quando a cena carrega\"\"\"
	var auto_dialogue = [
		{
			\"character\": \"Guarda\",
			\"text\": \"Bem vindo a sua nova casa!\"
		},
		{
			\"character\": \"Guarda\",
			\"text\": \"Mas não por muito tempo, a gente sabe o que você fez.\"
		},
		{
			\"character\": \"Guarda\",
			\"text\": \"E gente que nem você não dura muito tempo por aqui.\"
		},
		{
			\"character\": \"V\",
			\"text\": \"Eu não me importo com essa sua falação.\"
		},
		{
			\"character\": \"V\",
			\"text\": \"Se eu tivesse outra oportunidade, faria tudo igual.\"
		},
		{
			\"character\": \"Guarda\",
			\"text\": \"Vamos ver quanto tempo dura essa sua marra.\"
		}
	]
	
	start_dialogue(auto_dialogue)

func start_dialogue(dialogue_array: Array):
	\"\"\"Inicia um novo diálogo com o array de dados fornecido\"\"\"
	dialogue_data = dialogue_array
	current_dialogue_index = 0
	is_dialogue_active = true
	
	gray_filter.visible = true
	dialogue_box.visible = true
	
	get_tree().paused = false
	
	show_current_dialogue()

func show_current_dialogue():
	\"\"\"Mostra o diálogo atual\"\"\"
	if current_dialogue_index >= dialogue_data.size():
		end_dialogue()
		return
	
	var current_data = dialogue_data[current_dialogue_index]
	character_name.text = current_data.get(\"character\", \"\")
	
	start_typing_animation(current_data.get(\"text\", \"\"))

func start_typing_animation(text: String):
	\"\"\"Anima o texto sendo digitado letra por letra\"\"\"
	is_typing = true
	dialogue_text.text = \"\"
	continue_button.visible = false
	
	for i in range(text.length()):
		dialogue_text.text += text[i]
		await get_tree().create_timer(text_speed).timeout
		
		# Permite pular a animação
		if Input.is_action_just_pressed(\"ui_accept\"):
			dialogue_text.text = text
			break
	
	is_typing = false
	continue_button.visible = true

func _on_continue_pressed():
	\"\"\"Chamado quando o botão de continuar é pressionado\"\"\"
	if is_typing:
		return
	
	current_dialogue_index += 1
	show_current_dialogue()

func end_dialogue():
	\"\"\"Termina o diálogo atual\"\"\"
	is_dialogue_active = false
	dialogue_box.visible = false
	gray_filter.visible = false
	get_tree().paused = false
	dialogue_finished.emit()

func _input(event):
	\"\"\"Permite avançar o diálogo com teclas\"\"\"
	if not is_dialogue_active or is_typing:
		return
	
	if event.is_action_pressed(\"ui_accept\") or event.is_action_pressed(\"ui_select\"):
		_on_continue_pressed()
"

[sub_resource type="GDScript" id="GDScript_1661b"]
script/source = "extends ColorRect

func _ready():
	visible = true
	set_anchors_and_offsets_preset(Control.PRESET_FULL_RECT)

	color = Color(0.2, 0.2, 0.2, 0.8)

func activate_filter():
	visible = true

func deactivate_filter():
	visible = false
"

[sub_resource type="AtlasTexture" id="AtlasTexture_xr6cb"]
atlas = ExtResource("3_b1ot8")
region = Rect2(0, 0, 80, 256)

[sub_resource type="AtlasTexture" id="AtlasTexture_03d2k"]
atlas = ExtResource("3_b1ot8")
region = Rect2(80, 0, 80, 256)

[sub_resource type="AtlasTexture" id="AtlasTexture_p1je7"]
atlas = ExtResource("3_b1ot8")
region = Rect2(160, 0, 80, 256)

[sub_resource type="AtlasTexture" id="AtlasTexture_qh0bm"]
atlas = ExtResource("3_b1ot8")
region = Rect2(240, 0, 80, 256)

[sub_resource type="SpriteFrames" id="SpriteFrames_ntjli"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_xr6cb")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_03d2k")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_p1je7")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_qh0bm")
}],
"loop": true,
"name": &"default",
"speed": 5.0
}]

[sub_resource type="AtlasTexture" id="AtlasTexture_b1ot8"]
atlas = ExtResource("4_ft4dl")
region = Rect2(0, 0, 76, 228)

[sub_resource type="AtlasTexture" id="AtlasTexture_ft4dl"]
atlas = ExtResource("4_ft4dl")
region = Rect2(76, 0, 76, 228)

[sub_resource type="AtlasTexture" id="AtlasTexture_ntjli"]
atlas = ExtResource("4_ft4dl")
region = Rect2(152, 0, 76, 228)

[sub_resource type="AtlasTexture" id="AtlasTexture_81pkf"]
atlas = ExtResource("4_ft4dl")
region = Rect2(228, 0, 76, 228)

[sub_resource type="SpriteFrames" id="SpriteFrames_xr6cb"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_b1ot8")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ft4dl")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ntjli")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_81pkf")
}],
"loop": true,
"name": &"default",
"speed": 5.0
}]

[node name="PrisonCutscene" type="Node2D"]

[node name="DialogueManager" type="Control" parent="."]
layout_mode = 3
anchors_preset = 0
offset_right = 1920.0
offset_bottom = 1080.0
script = SubResource("GDScript_b1ot8")

[node name="TextureRect" type="TextureRect" parent="DialogueManager"]
layout_mode = 0
offset_right = 1920.0
offset_bottom = 1080.0
texture = ExtResource("1_1661b")

[node name="GrayFilter" type="ColorRect" parent="DialogueManager"]
visible = false
layout_mode = 0
offset_right = 1920.0
offset_bottom = 1080.0
script = SubResource("GDScript_1661b")

[node name="DialogueBox" type="Panel" parent="DialogueManager"]
layout_mode = 0
offset_left = 569.0
offset_top = 908.0
offset_right = 1379.0
offset_bottom = 1019.0

[node name="NameLabel" type="Label" parent="DialogueManager/DialogueBox"]
layout_mode = 0
offset_left = 12.0
offset_top = 8.0
offset_right = 134.0
offset_bottom = 43.0

[node name="TextLabel" type="Label" parent="DialogueManager/DialogueBox"]
layout_mode = 0
offset_left = 17.0
offset_top = 47.0
offset_right = 776.0
offset_bottom = 88.0

[node name="ContinueButton" type="Button" parent="DialogueManager/DialogueBox"]
layout_mode = 0
offset_left = 679.0
offset_top = 79.0
offset_right = 810.0
offset_bottom = 111.0

[node name="CharacterPortraits" type="HBoxContainer" parent="DialogueManager"]
layout_mode = 0
offset_top = 264.0
offset_right = 1920.0
offset_bottom = 1080.0
script = ExtResource("3_ft4dl")

[node name="RightPortraits" type="AnimatedSprite2D" parent="DialogueManager/CharacterPortraits"]
position = Vector2(1582, 692)
scale = Vector2(4.25781, 4.25781)
sprite_frames = SubResource("SpriteFrames_ntjli")
flip_h = true

[node name="LeftPortraits" type="AnimatedSprite2D" parent="DialogueManager/CharacterPortraits"]
position = Vector2(334, 710)
scale = Vector2(4.25781, 4.25781)
sprite_frames = SubResource("SpriteFrames_xr6cb")
